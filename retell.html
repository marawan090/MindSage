<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Retell Agent with SDK</title>
</head>
<body>
  <h1>🎙️ Retell Agent داخل موقعك</h1>

  <button onclick="joinCall()">▶️ بدء الجلسة</button>
  <button onclick="leaveCall()">⏹️ إيقاف الجلسة</button>

  <p id="status">⚪ جاهز للتشغيل</p>

  <!-- Step 1: Include Retell SDK -->
  <script src="https://cdn.retellai.com/web-sdk/index.min.js"></script>

  <script>
    // Step 2: بيانات الـ Agent والمفتاح
    const agentId = "agent_ac97619bfb93997ccf71cff3d5"; // ← غيره بـ Agent ID بتاعك
    const apiKey = "key_9d940c8b806dd4757857040e9e74";  // ← غيره بمفتاحك السري

    let callId = null;
    let webCall = null;

    // Step 3: بدء الجلسة
    async function joinCall() {
      document.getElementById("status").innerText = "⏳ جاري بدء الجلسة...";

      try {
        // Step 4: أنشئ المكالمة من API
        const response = await fetch("https://api.retellai.com/v2/create-web-call", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${apiKey}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            agent_id: agentId
          })
        });

        const data = await response.json();
        console.log("🎯 استجابة Retell:", data);

        if (!data.call_id) {
          document.getElementById("status").innerText = "❌ فشل في الحصول على call_id.";
          return;
        }

        callId = data.call_id;

        // Step 5: انضم للمكالمة باستخدام SDK
        webCall = await window.retellWebSDK.joinCall({
          callId,
          enableLocalAudioPlayback: true // يسمح بتشغيل الصوت في الموقع
        });

        document.getElementById("status").innerText = "🟢 الجلسة بدأت بنجاح.";
        console.log("✅ الجلسة بدأت");
      } catch (error) {
        console.error("❌ خطأ:", error);
        document.getElementById("status").innerText = "❌ حدث خطأ أثناء التشغيل.";
      }
    }

    // Step 6: إيقاف الجلسة
    async function leaveCall() {
      if (webCall) {
        await webCall.leaveCall();
        document.getElementById("status").innerText = "🔴 الجلسة توقفت.";
        console.log("⛔ تم الخروج من المكالمة");
      }
    }
  </script>
</body>
</html>
